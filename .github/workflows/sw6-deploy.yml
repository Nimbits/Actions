name: Deploy to Shopware 6

on:
  workflow_call:
    inputs:
      remote_host:
        required: true
        type: string
      remote_user:
        required: true
        type: string
      target_path:
        required: true
        type: string
    secrets:
      REMOTE_PWD:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Debug Variables
      run: |
        echo "Remote Host: ${{ inputs.remote_host }}"
        echo "Remote User: ${{ inputs.remote_user }}"
        echo "Target Path: ${{ inputs.target_path }}"

    - name: Get latest tag
      id: latest_tag
      uses: actions-ecosystem/action-get-latest-tag@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Update version in composer.json
      run: jq '.version = "${{ steps.latest_tag.outputs.tag }}"' composer.json > composer.tmp.json && mv composer.tmp.json composer.json

    - name: Create list of files to exclude
      run: echo "README.md .git* .eslint* .env* .prettier*" > files_to_exclude.txt
    
    - name: Create list of files to include
      run: ls -A1 | grep -v -F -f files_to_exclude.txt > files_to_include.txt

    - name: Deployment to temporary directory and replace old directory
      uses: appleboy/ssh-action@master
      with:
        host: ${{ inputs.remote_host }}
        username: ${{ inputs.remote_user }}
        password: ${{ secrets.REMOTE_PWD }}
        script: |
          # SCP files to temporary directory
          scp files_to_include.txt ${{ inputs.remote_user }}@${{ inputs.remote_host }}:${{ inputs.target_path }}/ci_temp/${{ github.event.repository.name }}
          
          # Replace old directory with new one
          rm -rf ${{ inputs.target_path }}/custom/plugins/${{ github.event.repository.name }}
          mv ${{ inputs.target_path }}/ci_temp/${{ github.event.repository.name }} ${{ inputs.target_path }}/custom/plugins/${{ github.event.repository.name }}
